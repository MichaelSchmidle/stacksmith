services:
  homeassistant-init:
    image: alpine:latest
    container_name: stacksmith_homeassistant_init
    volumes:
      - homeassistant-config:/config
    command: |
      sh -c "
      if [ ! -f /config/configuration.yaml ]; then
        echo 'Creating initial configuration.yaml...'
        cat > /config/configuration.yaml << 'EOF'
      # Minimal Home Assistant Configuration
      # This file provides only the essential configuration needed for Traefik integration
      # All other configuration should be done through the Home Assistant UI after deployment

      # Configure HTTP for reverse proxy (Traefik) - REQUIRED
      http:
        # Required for reverse proxy setups
        use_x_forwarded_for: true
        # Trust Traefik reverse proxy (Docker networks and common LAN ranges)
        trusted_proxies:
          - 172.16.0.0/12
          - 192.168.0.0/16
          - 10.0.0.0/8

      # Default configuration - Home Assistant will prompt for setup via UI
      default_config:

      # Enable UI-created automations
      automation: !include automations.yaml
      EOF
        touch /config/automations.yaml
        echo 'Initial configuration created successfully'
      else
        echo 'Configuration already exists, skipping...'
      fi
      "

  homeassistant:
    image: lscr.io/linuxserver/homeassistant:latest
    container_name: stacksmith_homeassistant
    restart: unless-stopped
    depends_on:
      - homeassistant-init
    devices:
      - ${ZIGBEE_DEVICE:-/dev/null}:/dev/ttyUSB0
    group_add:
      - dialout
    network_mode: host
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-UTC}
    volumes:
      - homeassistant-config:/config
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.homeassistant.rule=Host(`${HOMEASSISTANT_HOSTNAME}`)"
      - "traefik.http.routers.homeassistant.entrypoints=websecure-tailscale"
      - "traefik.http.routers.homeassistant.tls.certresolver=stacksmith"
      - "traefik.http.services.homeassistant.loadbalancer.server.url=http://${HOMEASSISTANT_LAN_HOST}:8123"
      - "traefik.http.routers.homeassistant.middlewares=secure-headers@docker"

volumes:
  homeassistant-config: